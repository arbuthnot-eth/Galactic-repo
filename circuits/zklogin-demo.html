<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galactic zk-Login Demo</title>
    <script src="https://cdn.jsdelivr.net/npm/snarkjs@0.7.5/build/snarkjs.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #1a2332 0%, #2a3d52 100%);
            color: #f4f1ef;
            min-height: 100vh;
        }
        .container {
            background: linear-gradient(145deg, #1e3a52 0%, #2d4a66 100%);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.4);
            border: 1px solid rgba(69, 139, 189, 0.3);
        }
        h1 {
            color: #f4f1ef;
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        .form-group {
            margin: 20px 0;
        }
        label {
            display: block;
            margin-bottom: 8px;
            color: #c3d5e8;
            font-weight: 500;
        }
        input {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(69, 139, 189, 0.4);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: #f4f1ef;
            font-size: 16px;
            box-sizing: border-box;
        }
        input:focus {
            outline: none;
            border-color: #458BBD;
            box-shadow: 0 0 0 2px rgba(69, 139, 189, 0.3);
        }
        button {
            background: linear-gradient(145deg, #458BBD, #5A9BD4);
            color: #f4f1ef;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 3px 8px rgba(0,0,0,0.3);
            border: 1px solid rgba(90,155,212,0.3);
        }
        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }
        button:disabled {
            background: rgba(69, 139, 189, 0.4);
            cursor: not-allowed;
            transform: none;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(69, 139, 189, 0.3);
        }
        .result h3 {
            margin-top: 0;
            color: #c3d5e8;
        }
        .result pre {
            background: rgba(0, 0, 0, 0.3);
            padding: 12px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 12px;
            color: #f4f1ef;
        }
        .status {
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            display: inline-block;
        }
        .status.loading {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }
        .status.success {
            background: rgba(40, 167, 69, 0.2);
            color: #28a745;
        }
        .status.error {
            background: rgba(220, 53, 69, 0.2);
            color: #dc3545;
        }
        .loading-spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(69, 139, 189, 0.3);
            border-radius: 50%;
            border-top-color: #458BBD;
            animation: spin 1s ease-in-out infinite;
            margin-left: 8px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .info-box {
            background: rgba(0, 123, 255, 0.1);
            border: 1px solid rgba(0, 123, 255, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }
        .info-box h4 {
            margin-top: 0;
            color: #5A9BD4;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üõ°Ô∏è Galactic zk-Login Demo</h1>

        <div class="info-box">
            <h4>‚ÑπÔ∏è What is this?</h4>
            <p>This demo shows how zk-Login works using Circom circuits and zero-knowledge proofs. You'll prove knowledge of a secret password without revealing it!</p>
        </div>

        <div class="form-group">
            <label for="secret">Enter your secret password:</label>
            <input type="password" id="secret" placeholder="Enter any secret password...">
        </div>

        <div class="form-group">
            <label for="commitment">Or enter a commitment to verify against (optional):</label>
            <input type="text" id="commitment" placeholder="Leave empty to compute from password...">
        </div>

        <button id="generateProof" onclick="generateZkProof()">
            üîê Generate zk-Proof
        </button>

        <div id="status" class="result" style="display: none;">
            <h3>Status: <span id="statusText"></span></h3>
            <div id="resultContent"></div>
        </div>
    </div>

    <script>
        let isGenerating = false;

        async function loadFile(url) {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`Failed to load ${url}: ${response.status}`);
            }
            return await response.arrayBuffer();
        }

        async function poseidonHash(value) {
            // For this demo, we'll use a simple hash function
            // In a real implementation, you'd use the same Poseidon as in the circuit
            let hash = 0;
            for (let i = 0; i < value.length; i++) {
                const char = value.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32-bit integer
            }
            return BigInt(Math.abs(hash));
        }

        async function generateZkProof() {
            if (isGenerating) return;

            const statusDiv = document.getElementById('status');
            const statusText = document.getElementById('statusText');
            const resultContent = document.getElementById('resultContent');
            const button = document.getElementById('generateProof');

            // Get user input
            const secretInput = document.getElementById('secret').value;
            const commitmentInput = document.getElementById('commitment').value;

            if (!secretInput) {
                alert('Please enter a secret password');
                return;
            }

            isGenerating = true;
            button.disabled = true;
            button.innerHTML = '‚è≥ Generating Proof <span class="loading-spinner"></span>';

            statusDiv.style.display = 'block';
            statusText.textContent = 'Loading circuit files...';
            statusText.className = 'status loading';

            try {
                // Load circuit files
                const wasmBuffer = await loadFile('build/zklogin_js/zklogin.wasm');
                const zkeyBuffer = await loadFile('build/zklogin_0000.zkey');

                statusText.textContent = 'Computing Poseidon commitment...';

                // Compute commitment if not provided
                let commitment;
                if (commitmentInput) {
                    commitment = BigInt(commitmentInput);
                } else {
                    commitment = await poseidonHash(secretInput);
                }

                // Build witness
                statusText.textContent = 'Building witness...';

                const witness = {
                    pwd: BigInt(secretInput.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0)),
                    commitment: commitment
                };

                // Load witness calculator
                const { WitnessCalculatorBuilder } = await import('./build/zklogin_js/witness_calculator.js');

                statusText.textContent = 'Calculating witness...';

                // Calculate witness
                const witnessCalculator = await WitnessCalculatorBuilder(wasmBuffer);
                const witnessBuffer = await witnessCalculator.calculateWTNSBin(witness, 0);

                // Generate proof
                statusText.textContent = 'Generating zero-knowledge proof...';

                const { proof, publicSignals } = await snarkjs.groth16.prove(
                    new Uint8Array(zkeyBuffer),
                    witnessBuffer
                );

                // Verify proof
                statusText.textContent = 'Verifying proof...';

                const vkeyResponse = await fetch('build/verification_key.json');
                const vkey = await vkeyResponse.json();
                const isValid = await snarkjs.groth16.verify(vkey, publicSignals, proof);

                // Display results
                statusText.textContent = '‚úÖ Proof Generated Successfully!';
                statusText.className = 'status success';

                resultContent.innerHTML = `
                    <h4>üîê Zero-Knowledge Proof Results:</h4>
                    <p><strong>Public Commitment:</strong> <code>${commitment.toString()}</code></p>
                    <p><strong>Proof Verified:</strong> <span style="color: #28a745;">${isValid ? '‚úÖ Valid' : '‚ùå Invalid'}</span></p>

                    <h4>üìã Proof Details:</h4>
                    <pre>${JSON.stringify(proof, null, 2)}</pre>

                    <h4>üéØ Public Signals:</h4>
                    <pre>${JSON.stringify(publicSignals, null, 2)}</pre>

                    <div class="info-box">
                        <h4>üéâ Success!</h4>
                        <p>You've successfully generated a zero-knowledge proof! The proof demonstrates knowledge of the secret password without revealing it. The server can verify this proof using the verification key to authenticate you without ever seeing your password.</p>
                    </div>
                `;

            } catch (error) {
                console.error('Error:', error);
                statusText.textContent = '‚ùå Error Generating Proof';
                statusText.className = 'status error';
                resultContent.innerHTML = `<pre style="color: #dc3545;">${error.message}</pre>`;
            } finally {
                isGenerating = false;
                button.disabled = false;
                button.innerHTML = 'üîê Generate zk-Proof';
            }
        }

        // Load snarkjs witness calculator builder
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Pre-load the witness calculator script
                await import('./build/zklogin_js/witness_calculator.js');
                console.log('‚úÖ Circuit files loaded successfully');
            } catch (error) {
                console.warn('Could not pre-load witness calculator:', error);
            }
        });
    </script>
</body>
</html>

